---
layout: post
title: "Quantum Graph"
date: 2023-04-23
author: red1108
tags: [computer-architecture, struct-memory, memory]
---

## 서론

> 이 글은 우리가 PS를 할 때 조금이나마 도움이 되는 꿀팁을 주는것이 목적이다. 구조체를 사용할 때 간과했던 변수들 간의 순서가 메모리에 어떤 영향을 주는지 다룬다.

## 구조체의 메모리 계산

### 예시

PS가 아닌 개발을 목적으로 한 프로그래밍을 할 때에는 **보통** 가독성을 중요하게 생각한다. 다음과 같은 c++ 코드를 생각해 보자.

```cpp
const int SIZE = 1000000;
struct User{
    char sex;
    short age;
    long long id;
} db[SIZE];
```

유저의 성별, 나이, 고유한 id를 설정해야 하는 상황이다. 우선 위와 같이 설정한 이유를 간략히 설명하겠다.

- 성별은 'M' / 'F'를 담을 수 있도록 char로 설정하였다.
- 사람의 나이는 short로도 충분히 담을 수 있다. 메모리를 조금이라도 아끼기 위해 굳이 int가 아닌 short로 설정하였다.
- 지금은 db크기가 1,000,000뿐이지만 세계 인구 수는 80억이 넘으므로 long long으로 id를 지정하였다.

위 이유들은 충분히 합리적으로 보이고, 메모리 관점에서 구조체를 설계하는데 특별히 더 손볼 곳이 없어 보인다. (나이를 저장하기 위해서는 char로도 충분하지만, 언젠가 255세를 넘게 사는 사람도 있지 않겠는가..? 그리고 너무 비직관적이기도 하니 넘어가자)

그럼 **User** 구조체는 크기가 얼마일까? 맨 처음 드는 생각은 char이 1바이트, short가 2바이트, long long int가 8바이트니 1 + 2 + 8 = 11바이트가 차지되지 않을까 하는 생각이 든다. 저 구조체가 실제로 차지하는 용량은 아래의 코드를 통해 쉽게 확인할 수 있다.

```cpp
printf("Size of User struct = %d bytes\n", sizeof(db[0]));
```

실행 결과 User구조체는 **16 bytes**를 차지하고 있었다. 예상보다 5바이트나 더 차지하고 있었다.

또한 설계자의 작은 고민을 통해 **int** age를 **short** age로 바꾸었다는 점을 떠올려 보자. 여기서 우리는 저 short를 int로 바꾸어도 구조체가 차지하는 크기는 여전히 16 bytes임을 확인할 수 있다.

```cpp
const int SIZE = 1000000;
struct User{
    char sex;
    int age; //short -> int
    long long id;
} db[SIZE];
```

위 코드의 실행 결과는 attribute하나를 short에서 int로 바꿨음에도 차지하는 용량에는 변화가 없음을 보여준다.

더 놀라운 사실은 모든 변수명의 타입을 유지하면서 단순히 변수 순서만을 바꿨을 뿐인데도 구조체의 크기가 바뀐다는 점이다. 예컨데, 아래 코드에서 구조체가 차지하는 용량은 **24 bytes**이다.

```cpp
const int SIZE = 1000000;
struct User{
    char sex;
    long long id; //id와 age의 순서를 교환
    short age;
} db[SIZE];
```

정리하자면
1. 변수명의 타입을 바꾸었는데도 차지하는 용량이 그대로일 수 있다.
2. 타입을 유지하면서 정의 순서를 바꾸면 차지하는 용량이 바뀔 수 있다.

이제부터 그 이유를 살펴보도록 하자. 이 차이를 이해한다면 앞으로 2D segment tree나 persistent segment tree, splay tree, Trie, Aho–Corasick 등등 **맞춤화된 구조체**를 설계해서 해결해야하는 문제 (특히 이런 문제들의 특징은 메모리 제한이 빡빡하단 점이다)에 적용하여 메모리 용량 초과를 회피하는데 조금이나마 도움이 될 수 있을 것이다.

### 구조체의 메모리 할당 구조

컴퓨터에서 여러 값들이 메모리에 저장될 때 특정 주소에 저장되고 있다는 사실은 다들 알고 있을 것이다. 또한 메모리들은 byte단위로 묶여서 저장되며 접근도 byte단위로만 가능하다. 주소에서 0x0010번이 8bit를 저장하고, 그 다음 주소인 0x0011이 그다음 8bit를 저장하고.. 이런 방식이다. 따라서 32bit 크기를 가지는 int 타입 변수는 메모리에 4개의 연속한 바이트를 차지하면서 저장된다.

![int저장](https://user-images.githubusercontent.com/17401630/234319732-ec9c4534-79b5-4b0e-9242-4b41df9805d0.png)

